## Fit step up function as used in boolean implication mining.
## Andrew Yates 2013
sse <- function(v) sum((v-mean(v))^2)

## compute sum squared error per step location "i"
## 1:i -> low step
## i+1:n -> high step
fit.upstep <- function(v, do.plots=FALSE) {
  R <- list()
  v <- sort(v)
  n <- length(v)
  R$v.sse <- sapply(1:(n-1), function(i) sse(v[1:i])+sse(v[(i+1):n]))
  R$idx <- which.min(R$v.sse)
  R$sum.sse <- R$v.sse[R$idx]
  R$th <- (v[R$idx]+v[R$idx+1])/2
  R$low <- mean(v[1:R$idx])
  R$high <- mean(v[(R$idx+1):n])
  R$mean <- mean(v)
  R$mean.idx <- tail(which(v<=mean(v)), 1)
  R$median <- median(v)
  R$median.idx <- max(floor(length(v)/2),1)
  R
}

plot.sse <- function(R, add.mean.median=FALSE) {
  plot(R$v.sse, xlab="Highest Index In Low Step", ylab="Sum of Sum Squared Errors")
  abline(h=R$sum.sse, col="#cc0000", lty=1)
  abline(v=R$idx, col="#cc0000", lty=3)
  points(R$idx, R$v.sse[R$idx], col="#ff0000", pch=15, cex=3)
  if(add.mean.median) {
    # mean
    abline(v=R$mean.idx, col="#0000cc", lty=3)
    abline(h=R$v.sse[R$mean.idx], col="#0000cc", lty=1)
    points(R$mean.idx, R$v.sse[R$mean.idx], col="#0000cc", pch=16, cex=3)
    # median
    abline(v=R$median.idx, col="#009900", lty=3)
    abline(h=R$v.sse[R$median.idx], col="#009900", lty=1)
    points(R$median.idx, R$v.sse[R$median.idx], col="#009900", pch=17, cex=3)    
  }
}


plot.stepfit <- function(R, v, add.mean.median=FALSE) {
  v <- sort(v)
  plot(v, xlab="Rank", ylab="Log Expression")
  abline(h=R$th, col="#990000", lty=3)
  abline(v=R$idx, col="#990000", lty=3)
  abline(h=R$high, col="#cc0000", lwd=2, lty=3)
  abline(h=R$low, col="#cc0000", lwd=2, lty=3)
  segments(x0=0, y0=R$low, x1=R$idx, y1=R$low, col="#ff0000", lwd=6)
  segments(x0=R$idx, y0=R$low, x1=R$idx, y1=R$high, col="#ff0000", lwd=6)
  segments(x0=R$idx, y0=R$high, x1=length(row1)+1, y1=R$high, col="#ff0000", lwd=6)
  points(R$idx+0.5, R$th, col="#ff0000", pch=15, cex=3)
  
  if(add.mean.median) {
    abline(h=R$mean, col="#0000cc", lty=2, lwd=2)
    points(R$mean.idx, R$mean, col="#0000cc", pch=16, cex=3)
    abline(h=R$median, col="#009900", lty=2, lwd=2)
    points(R$median.idx, R$median, col="#009900", pch=17, cex=3)
  }
}


## Test
## ---------------------------------
## Test expression data "row1"
## is log transformed and normalized expression from probe
## ILMN_1787689, gene A2BP1 in combined Gibbs four brain tissue mRNA
## data on Illumina Bead Array platform.
##
# row1 <- c(5.220542,5.364648,5.403960,5.456219,5.473738,5.516390,5.529153,5.533470,5.562867,5.590467,5.605861,5.667480,5.689584,5.699834,5.738980,5.751147,5.754855,5.771449,5.771576,5.773163,5.797608,5.823261,5.825229,5.870971,5.881825,5.882956,5.893594,5.895853,5.912800,5.917930,5.925635,5.930729,5.937815,5.951976,5.954930,5.955651,5.969870,5.970886,5.994604,5.999751,6.010296,6.015872,6.018703,6.024500,6.028527,6.031944,6.033942,6.036193,6.052554,6.064321,6.065971,6.069042,6.070977,6.077391,6.102372,6.116323,6.123390,6.125002,6.131783,6.135713,6.137837,6.143011,6.146690,6.149298,6.149350,6.161573,6.164731,6.170586,6.173834,6.174845,6.183129,6.187624,6.190684,6.194778,6.200687,6.201026,6.205425,6.205809,6.209807,6.211758,6.212256,6.212747,6.215913,6.217327,6.220159,6.220519,6.220797,6.227943,6.231676,6.231702,6.233357,6.242455,6.248537,6.248917,6.248947,6.252934,6.257241,6.262610,6.270838,6.273120,6.277190,6.279085,6.280619,6.280775,6.286435,6.290472,6.293657,6.298092,6.299019,6.306500,6.307339,6.308200,6.309666,6.311256,6.311998,6.312140,6.317015,6.318144,6.320212,6.320218,6.323457,6.334685,6.336623,6.337327,6.338083,6.338341,6.338399,6.339829,6.343935,6.351037,6.353873,6.358306,6.359383,6.366195,6.370039,6.375125,6.376121,6.376546,6.377194,6.377213,6.382465,6.386225,6.386905,6.390130,6.390528,6.396772,6.400517,6.400768,6.401554,6.403241,6.403292,6.404542,6.405007,6.406202,6.410347,6.414201,6.416801,6.417087,6.417217,6.422908,6.423823,6.424813,6.424856,6.426374,6.430018,6.430305,6.432705,6.433271,6.436405,6.440617,6.444959,6.446845,6.448286,6.451864,6.453552,6.455087,6.456079,6.460780,6.462278,6.462580,6.462941,6.465861,6.469114,6.469645,6.474242,6.474925,6.475099,6.475956,6.476470,6.486839,6.487169,6.488802,6.489115,6.492073,6.493147,6.496755,6.499745,6.500945,6.505358,6.508895,6.509502,6.510554,6.512218,6.518843,6.519366,6.519482,6.522672,6.525827,6.529624,6.534639,6.548427,6.554564,6.557944,6.559056,6.561077,6.566679,6.568066,6.568396,6.568713,6.569668,6.571211,6.573708,6.581053,6.583274,6.583924,6.585899,6.593007,6.593935,6.597581,6.611663,6.612332,6.613068,6.614823,6.614951,6.624327,6.627248,6.628511,6.630685,6.631147,6.633392,6.634885,6.635268,6.640981,6.646092,6.647514,6.647538,6.653974,6.655969,6.671037,6.674492,6.674988,6.676690,6.678263,6.685572,6.688633,6.690812,6.691011,6.699197,6.700386,6.703983,6.708217,6.710980,6.715821,6.716652,6.720638,6.731309,6.733020,6.733559,6.736792,6.737659,6.744952,6.754031,6.754163,6.755108,6.755396,6.756396,6.779161,6.796778,6.802337,6.816355,6.817047,6.817463,6.823727,6.833179,6.840448,6.843245,6.845677,6.850019,6.853270,6.859533,6.867486,6.872097,6.873646,6.882489,6.886008,6.891639,6.895080,6.906675,6.910743,6.912362,6.915331,6.920945,6.927180,6.928209,6.940068,6.940630,6.945523,6.959656,6.962995,6.970175,6.971529,6.975741,6.981505,6.999809,7.008166,7.010741,7.018561,7.025312,7.030341,7.037643,7.043904,7.049964,7.053660,7.055861,7.059417,7.066449,7.066508,7.086292,7.088824,7.099302,7.126347,7.127721,7.150162,7.160345,7.164930,7.171232,7.175421,7.177390,7.191645,7.232630,7.237949,7.245265,7.245799,7.294619,7.303791,7.311998,7.322090,7.331282,7.336070,7.374419,7.379205,7.381507,7.393030,7.397158,7.424495,7.425399,7.430887,7.450420,7.456377,7.472028,7.476047,7.476112,7.482928,7.488883,7.489138,7.491910,7.492755,7.498781,7.504099,7.527228,7.559949,7.563846,7.565355,7.567282,7.572808,7.573834,7.578654,7.584913,7.588033,7.590990,7.615687,7.619012,7.629467,7.635196,7.639813,7.652589,7.677513,7.685043,7.685667,7.686625,7.688778,7.712642,7.719856,7.719947,7.726131,7.734071,7.734602,7.739317,7.756686,7.791384,7.802084,7.809108,7.812891,7.820279,7.822259,7.828322,7.851686,7.875981,7.926106,7.927893,7.951556,7.951773,7.983321,8.001185,8.011481,8.021852,8.037020,8.117189,8.166180,8.260163)
# sum((row1-mean(row1))^2)
# R <- fit.upstep(row1)
# R$sum.sse
# plot.sse(R)
# plot.sse(R, add.mean.median=TRUE)
# plot.stepfit(R, row1)
# plot.stepfit(R, row1, add.mean.median=TRUE)

